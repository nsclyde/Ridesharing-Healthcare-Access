---
title: "Empirical Analyses Reproduction for "
author: "Nick Clyde"
date: "2023-03-02"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(warning = FALSE, message=FALSE,echo = TRUE)
library(DescTools)
library(lfe)
library(dplyr)
library(beepr)
library(MatchIt)
library(dplyr)
library(ggplot2)
library(fixest)
library(Lahman)
library(sendmailR)
library(stargazer)
library(caTools)
library(httpuv)
library(psych)
library(xtable)
library(tidyr)

```

# Reading in Data

Read in the data that was prepped with the Directions_API_Requests.py file

```{r}
uber_providers = read.csv("Data/uber_providers_Reproduction.csv")
```


Define cities to include in empirical analyses, take out providers who switch between treatment and control cities, define treatment group, and define After Reentry period

```{r}
#Define variable to take out all observations that are not from control or treatment city

uber_providers$similar_to_austin=ifelse(uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock",1,0)


# Take out all providers who moved between treatment group and control cities
# First, get number of distinct cities for each provider within our subset

provider_city_count <- subset(uber_providers, similar_to_austin==1) %>%
  group_by(PRSCRBR_NPI) %>%
  summarise(city_count = n_distinct(Prscrbr_City))


# Get providers that are in more than one city 

multi_city_providers <- provider_city_count %>%
  filter(city_count > 1) %>%
  pull(PRSCRBR_NPI)

# Check if these providers have Austin as one of their cities
providers_with_austin <- subset(uber_providers, similar_to_austin==1) %>%
  filter(Prscrbr_City == 'Austin') %>%
  pull(PRSCRBR_NPI) %>%
  unique()

# Find providers who moved from control city to Austin or vice versa

mixed_providers <- intersect(multi_city_providers, providers_with_austin)

# Create the 'mixed' column in uber_providers to identify the providers who moved

uber_providers <- uber_providers %>% 
  mutate(mixed = ifelse(PRSCRBR_NPI %in% mixed_providers, 1, 0))


#Now define similar_to_austin as providers who are in treatment or control cities and do not move between

uber_providers$similar_to_austin=ifelse(uber_providers$mixed==0 &(uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock"),1,0)

# Define treatment_group as any provider from Austin

temp=subset(uber_providers, Prscrbr_City=="Austin")
uber_providers$treatment_group=0
uber_providers[uber_providers$PRSCRBR_NPI %in% unique(temp$PRSCRBR_NPI),]$treatment_group=1

```

# Summary Statistics

Create summary statistics

```{r}

#First define the Dual variable used in HTE

#define dual_perc variable
uber_providers$dual_perc=ifelse(((is.na(uber_providers$Tot_Benes)==FALSE) & (is.na(uber_providers$Bene_Dual_Cnt)==FALSE)),100*uber_providers$Bene_Dual_Cnt/uber_providers$Tot_Benes,NA)

temp <- uber_providers %>%
  filter(yearindicator >= 2013 & yearindicator <= 2015)

avg_dual <- temp %>%
  group_by(PRSCRBR_NPI) %>%
  summarize(avg_pre_dual = mean(dual_perc, na.rm = TRUE))

uber_providers <- uber_providers %>%
  left_join(avg_dual, by = "PRSCRBR_NPI")

#create subset of data for variables of interest in only control and treatment cities
temp=subset(uber_providers, similar_to_austin==1)
temp2=temp[,c("yearindicator","Tot_Clms","Tot_Benes","Bene_Avg_Risk_Scre","Prscrbr_City","avg_pre_dual")]

#First Austin in before periods
summary_stats=as.data.frame(describe(subset(temp2, Prscrbr_City=="Austin" & yearindicator<2018)))
selected_stats <- summary_stats %>%
  select(n, mean, sd)


statspre=as.data.frame(selected_stats)

#Austin in after periods
summary_stats=as.data.frame(describe(subset(temp2, Prscrbr_City=="Austin" & yearindicator>=2018)))
selected_stats <- summary_stats %>%
  select(n, mean, sd)


statsafter=as.data.frame(selected_stats)

stats=cbind(statspre,statsafter)


# create latex
latex_table <- xtable(stats)
print(latex_table, type = "latex")



#Control cities in before periods
summary_stats=as.data.frame(describe(subset(temp2, Prscrbr_City!="Austin" & yearindicator<2018)))
selected_stats <- summary_stats %>%
  select(n, mean, sd)


statspre=as.data.frame(selected_stats)

#Control cities in after periods
summary_stats=as.data.frame(describe(subset(temp2, Prscrbr_City!="Austin" & yearindicator>=2018)))
selected_stats <- summary_stats %>%
  select(n, mean, sd)


statsafter=as.data.frame(selected_stats)

stats=cbind(statspre,statsafter)


# create latex
latex_table <- xtable(stats)
print(latex_table, type = "latex")




```


# Main Results

## Parallel Trends - Austin
Try to get parallel trends with Austin, El Paso, Lubbock, and Amarillo

```{r}


paralleltrends = felm(Tot_Clms ~ I(treatment_group*yearindicator) + Bene_Avg_Risk_Scre| PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers, similar_to_austin==1 & yearindicator<2018))

paralleltrends3 = felm(Tot_Benes ~ I(treatment_group*yearindicator) + Bene_Avg_Risk_Scre| PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers, similar_to_austin==1 & yearindicator<2018  ))



stargazer(paralleltrends, paralleltrends3, digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'Yes','Yes'), 
                           c('Provider fixed effects', 'Yes','Yes')),
          title = "Parallel Trends", type="text")
```



## Diff in Diff

### Total Claims

```{r}
uber_providers$AfterReentry=ifelse(uber_providers$yearindicator>2017,1,0)

column1 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + AfterReentry |PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1))

column2 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1))


column3 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1))




stargazer(column1,column2,column3, digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="text",
          title = "Parallel Trends")

mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0)$Tot_Clms)

```

### Total Beneficiaries

```{r}


column1 = felm(Tot_Benes ~ I(treatment_group*AfterReentry) + AfterReentry |PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1))

column2 = felm(Tot_Benes ~ I(treatment_group*AfterReentry) |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1))


column3 = felm(Tot_Benes ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1))



#summary(riskregression)



stargazer(column1,  column2, column3, digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="text",
          title = "Parallel Trends")

mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0 & is.na(Tot_Benes)==FALSE)$Tot_Benes)

```


# HTE

Setup for the rest of the variables (Dual was defined back in summary statistics):

```{r}
#define risk_2015 variable



#Now define the HTE variables by averaging years 2013-2015
temp <- uber_providers %>%
  filter(yearindicator >= 2013 & yearindicator <= 2015)

avg_risk_score <- temp %>%
  group_by(PRSCRBR_NPI) %>%
  summarize(avg_pre_risk = mean(Bene_Avg_Risk_Scre, na.rm = TRUE))

avg_dual <- temp %>%
  group_by(PRSCRBR_NPI) %>%
  summarize(avg_pre_dual = mean(dual_perc, na.rm = TRUE))

# Step 3: Merge this average back into the original dataframe
uber_providers <- uber_providers %>%
  left_join(avg_risk_score, by = "PRSCRBR_NPI")




#standardize the risk scores for easier interpretation


stand_dev=sd(subset(uber_providers,similar_to_austin==1 & is.na(avg_pre_risk)==FALSE)$avg_pre_risk)

uber_providers$st_avg_pre_risk=uber_providers$avg_pre_risk/stand_dev
```


## Main HTE Results

Main HTE results using the average for each provider from 2013-2015

```{r}

column1 = felm(Tot_Clms ~  I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & is.na(st_avg_pre_risk)==FALSE))

column2 = felm(Tot_Clms ~  I(treatment_group*AfterReentry)*st_avg_pre_risk + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & is.na(st_avg_pre_risk)==FALSE))


column3 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & is.na(avg_pre_dual)==FALSE))

column4 = felm(Tot_Clms ~  I(treatment_group*AfterReentry)*avg_pre_dual + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & is.na(avg_pre_dual)==FALSE))



#summary(riskregression)

stargazer(column1,column2, column3, column4, digits=2, no.space=TRUE, p.auto=TRUE, single.row=FALSE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'Yes', 'Yes', 'Yes','Yes', 'Yes','Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes','Yes', 'Yes','Yes')),
          title = "Parallel Trends", type="text")

mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0 & is.na(avg_pre_dual)==FALSE)$Tot_Clms)
mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0 & is.na(st_avg_pre_risk)==FALSE)$Tot_Clms)

```

## Robustness HTE results


```{r}

uber_providers <- uber_providers %>%
  group_by(PRSCRBR_NPI) %>%
  mutate(risk_2015 = ifelse(any(yearindicator == 2015), Bene_Avg_Risk_Scre[yearindicator == 2015], NA)) %>%
  ungroup()

uber_providers <- uber_providers %>%
  group_by(PRSCRBR_NPI) %>%
  mutate(dual_2015 = ifelse(any(yearindicator == 2015), dual_perc[yearindicator == 2015], NA)) %>%
  ungroup()

stand_dev=sd(subset(uber_providers,similar_to_austin==1 & is.na(risk_2015)==FALSE)$risk_2015)

uber_providers$st_risk_2015=uber_providers$risk_2015/stand_dev

column1 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & is.na(st_risk_2015)==FALSE))

column2 = felm(Tot_Clms ~ I(treatment_group*AfterReentry)*st_risk_2015 + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & is.na(st_risk_2015)==FALSE))


column3 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & is.na(dual_2015)==FALSE))

column4 = felm(Tot_Clms ~I(treatment_group*AfterReentry)*dual_2015 + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & is.na(dual_2015)==FALSE))






#summary(riskregression)

stargazer(column1,column2, column3, column4, digits=2, no.space=TRUE, p.auto=TRUE, single.row=FALSE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'Yes', 'Yes', 'Yes','Yes', 'Yes','Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes','Yes', 'Yes','Yes')),
          title = "Parallel Trends", type="text")

mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0 & is.na(avg_pre_dual)==FALSE)$Tot_Clms)
mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0 & is.na(st_avg_pre_risk)==FALSE)$Tot_Clms)

```





# Mechanisms


## Median of mean walking duration

```{r}

median_of_mean=median(subset(uber_providers,similar_to_austin==1 & is.na(mean_duration)==FALSE)$mean_duration)

uber_providers$Urban=ifelse(uber_providers$mean_duration<median_of_mean, 1, 0)
uber_filtered=subset(uber_providers, similar_to_austin==1)

uber_filtered <- uber_filtered %>%
  group_by(PRSCRBR_NPI) %>%
  mutate(switching = ifelse(n_distinct(Urban) > 1, 1, 0)) %>%
  ungroup()




column1 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_filtered,similar_to_austin==1 &  switching==0))

column2 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_filtered,similar_to_austin==1 & Urban==1 & switching==0))

column3 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_filtered,similar_to_austin==1 & Urban==0 & switching==0))

column4 = felm(Tot_Clms ~ I(treatment_group*AfterReentry)*Urban + Bene_Avg_Risk_Scre|PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_filtered,similar_to_austin==1 & switching==0))





stargazer(column1,column2, column3,  column4, digits=2, no.space=TRUE, p.auto=TRUE, single.row=FALSE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'Yes', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),
          title = "Urban vs. Rural Providers", type="text")

#summary(riskregression)
mean(subset(uber_filtered,similar_to_austin==1 & treatment_group==0 & is.na(Urban)==FALSE & switching==0)$Tot_Clms)

```


## Traffic SDID Results

Here we use SDID to analyze if the re-entry of uber and lyft causes an increase in traffic in Austin. 

```{r}
traffic_data=read.csv("Data/TxDOT_AADT_Annuals.csv")


traffic_data <- traffic_data %>%
  pivot_longer(
    cols = starts_with("AADT"),
    names_to = "year",
    names_prefix = "AADT_",
    values_to = "AADT"
  )

traffic_df=as.data.frame(traffic_data)

traffic_df$year=as.numeric(traffic_df$year)
traffic_df$treatment_group=0

#Define treatment group
temp=subset(traffic_df, (DIST_NM=="Austin"))

traffic_df[traffic_df$ID %in% unique(temp$ID),"treatment_group"]=1

#filter down to years of interest
traffic_df=traffic_df[traffic_df$year>2012 & traffic_df$year<2021,]

traffic_sdid=as.data.frame(traffic_df)

library(synthdid)

#define treatment years
traffic_sdid$treated=ifelse(traffic_sdid$treatment_group==1 & traffic_sdid$year>2017,1,0)


mean(subset(traffic_sdid, treatment_group==0)$AADT)

traffic_sdid=traffic_sdid[,c("ID","year","AADT","treated")]

traffic_sdid <- traffic_sdid[with(traffic_sdid, order(year, treated, ID)), ]

traffic_sdid$ID=as.factor(traffic_sdid$ID)
# setup data in format needed for SDID
setup = panel.matrices(traffic_sdid)

#run SDID
tau.hat_synth = synthdid_estimate(setup$Y, setup$N0, setup$T0)
se = sqrt(vcov(tau.hat_synth, method='jackknife'))


sprintf('point estimate: %1.10f', tau.hat_synth)
sprintf('95%% CI (%1.2f, %1.2f)', tau.hat_synth - 1.96 * se, tau.hat_synth + 1.96 * se)
sprintf('se: %1.10f', se)


```



## Synthetic Matching of Transit Data

### Synthetic Control

Here we run synthetic control for Austin with Amarillo, El Paso, Lubbock, Dallas, Fort Worth, and Plano as control cities

```{r, echo=FALSE}
########################################################################################


library('Synth')


Texas_miles=read.csv("Data/Texas_Miles.csv", header=T, stringsAsFactors = FALSE)

Texas_miles$X=0
Texas_miles$X=ifelse(Texas_miles$City=="Amarillo",1,Texas_miles$X)
Texas_miles$X=ifelse(Texas_miles$City=="Austin",2,Texas_miles$X)
Texas_miles$X=ifelse(Texas_miles$City=="El Paso",3,Texas_miles$X)
Texas_miles$X=ifelse(Texas_miles$City=="Lubbock",4,Texas_miles$X)
Texas_miles$X=ifelse(Texas_miles$City=="Dallas",5,Texas_miles$X)
Texas_miles$X=ifelse(Texas_miles$City=="Fort Worth",6,Texas_miles$X)
Texas_miles$X=ifelse(Texas_miles$City=="Plano",7,Texas_miles$X)

#add column for value from each month for each city
df_combined <- Texas_miles %>%
  filter(t %in% c(1:55)) %>%
  select(City, t, value) %>%
  pivot_wider(names_from = t, values_from = value, names_prefix = "value_") 
 

# Join back to original data frame

Texas_miles <- Texas_miles %>%
  left_join(df_combined, by = "City")



# prep for synthetic control
dataprep.out <- dataprep(
  foo = Texas_miles,
  predictors = c("value_5","value_10","value_15","value_20","value_25","value_30","value_35","value_40","value_45","value_50","value_55"),
  predictors.op = "mean",
  time.predictors.prior = c(5,10,15,20,25,30,35,40,45,50,55),
  dependent = "value",
  unit.variable = "X",
  unit.names.variable = "City",
  time.variable = "t",
  treatment.identifier = 2, 
  controls.identifier = c(1,3,4,5,6,7), 
  time.optimize.ssr = c((0):(56)),
  time.plot = c((0):(99)) 
)

synth.out <- synth(dataprep.out)
synth.tables <- synth.tab(dataprep.res = dataprep.out, synth.res = synth.out)


# City Weights in the Synthetic Austin
print(synth.tables$tab.w)


# Mean of Pretreatment Characteristics

print(synth.tables$tab.pred)


# Trends of miles offered: Austin vs. Synthetic Control City
par(cex.lab = 1.3, cex.axis = 1.3, font.lab = 2) #change fonts
path.plot(synth.res = synth.out, dataprep.res = dataprep.out, tr.intake=56,
          Ylab = "Transit Miles", Xlab = "Month")

mean(gaps[0:56])

mean(gaps[57:99])

mean(dataprep.out$Y0plot%*%synth.out$solution.w)
# Gaps in miles offered between Austin and Synthetic Control City 
gaps.plot(synth.res = synth.out, dataprep.res = dataprep.out,
          Ylab = "Gap in Transit Riders", Xlab = "Month", tr.intake = 56, Main = NULL)


# Calculate the treatment effect using mean gap estimates after the treatment
gaps<- dataprep.out$Y1plot-(dataprep.out$Y0plot%*%synth.out$solution.w)


# define pre-treatment periods which are excluded for validation as any period used for matching
exclude_times <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55)
# Define the pre-treatment period
pre_treatment_period <- 0:56
# Filter out the time points to exclude from the pre-treatment period
valid_times <- setdiff(pre_treatment_period, exclude_times)
# Compute gaps for the valid times
valid_gaps <- gaps[valid_times + 1]  
# Calculate RMSPE on the filtered data
pre_RMSPE <- sqrt(mean(valid_gaps^2))
post_RMSPE = sqrt(mean(gaps[57:99]^2))
ratio=post_RMSPE/pre_RMSPE
print(paste("Austin RMSPE ratio:",ratio))
```

### Synthetic Control Placebo Tests

```{r, echo=FALSE}

# prep for synthetic control with Amarillo as Placebo City
dataprep.out <- dataprep(
  foo = Texas_miles,
  predictors = c("value_5","value_10","value_15","value_20","value_25","value_30","value_35","value_40","value_45","value_50","value_55"),
  predictors.op = "mean",
  time.predictors.prior = c(5,10,15,20,25,30,35,40,45,50,55),
  dependent = "value",
  unit.variable = "X",
  unit.names.variable = "City",
  time.variable = "t",
  treatment.identifier = 1, 
  controls.identifier = c(3,4,5,6,7), 
  time.optimize.ssr = c((0):(56)),
  time.plot = c((0):(99)) 
)

synth.out <- synth(dataprep.out)

# Calculate the treatment effect using mean gap estimates after the treatment
gaps<- dataprep.out$Y1plot-(dataprep.out$Y0plot%*%synth.out$solution.w)

# define pre-treatment periods which are excluded for validation as any period used for matching
exclude_times <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55)
# Define the pre-treatment period
pre_treatment_period <- 0:56
# Filter out the time points to exclude from the pre-treatment period
valid_times <- setdiff(pre_treatment_period, exclude_times)
# Compute gaps for the valid times
valid_gaps <- gaps[valid_times + 1]  
# Calculate RMSPE on the filtered data
pre_RMSPE <- sqrt(mean(valid_gaps^2))
post_RMSPE = sqrt(mean(gaps[57:99]^2))
ratio=post_RMSPE/pre_RMSPE
print(paste("Amarillo RMSPE ratio:",ratio))


#prep for synthetic control with El Paso as Placebo City
dataprep.out <- dataprep(
  foo = Texas_miles,
  predictors = c("value_5","value_10","value_15","value_20","value_25","value_30","value_35","value_40","value_45","value_50","value_55"),
  predictors.op = "mean",
  time.predictors.prior = c(5,10,15,20,25,30,35,40,45,50,55),
  dependent = "value",
  unit.variable = "X",
  unit.names.variable = "City",
  time.variable = "t",
  treatment.identifier = 3, 
  controls.identifier = c(1,4,5,6,7), 
  time.optimize.ssr = c((0):(56)),
  time.plot = c((0):(99)) 
)

synth.out <- synth(dataprep.out)

# Calculate the treatment effect using mean gap estimates after the treatment
gaps<- dataprep.out$Y1plot-(dataprep.out$Y0plot%*%synth.out$solution.w)

# define pre-treatment periods which are excluded for validation as any period used for matching
exclude_times <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55)
# Define the pre-treatment period
pre_treatment_period <- 0:56
# Filter out the time points to exclude from the pre-treatment period
valid_times <- setdiff(pre_treatment_period, exclude_times)
# Compute gaps for the valid times
valid_gaps <- gaps[valid_times + 1]  
# Calculate RMSPE on the filtered data
pre_RMSPE <- sqrt(mean(valid_gaps^2))
post_RMSPE = sqrt(mean(gaps[57:99]^2))
ratio=post_RMSPE/pre_RMSPE
print(paste("El Paso RMSPE ratio:",ratio))

#prep for synthetic control with Lubbock as Placebo City
dataprep.out <- dataprep(
  foo = Texas_miles,
  predictors = c("value_5","value_10","value_15","value_20","value_25","value_30","value_35","value_40","value_45","value_50","value_55"),
  predictors.op = "mean",
  time.predictors.prior = c(5,10,15,20,25,30,35,40,45,50,55),
  dependent = "value",
  unit.variable = "X",
  unit.names.variable = "City",
  time.variable = "t",
  treatment.identifier = 4, 
  controls.identifier = c(1,3,5,6,7), 
  time.optimize.ssr = c((0):(56)),
  time.plot = c((0):(99)) 
)

synth.out <- synth(dataprep.out)

# Calculate the treatment effect using mean gap estimates after the treatment
gaps<- dataprep.out$Y1plot-(dataprep.out$Y0plot%*%synth.out$solution.w)

# define pre-treatment periods which are excluded for validation as any period used for matching
exclude_times <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55)
# Define the pre-treatment period
pre_treatment_period <- 0:56
# Filter out the time points to exclude from the pre-treatment period
valid_times <- setdiff(pre_treatment_period, exclude_times)
# Compute gaps for the valid times
valid_gaps <- gaps[valid_times + 1]  
# Calculate RMSPE on the filtered data
pre_RMSPE <- sqrt(mean(valid_gaps^2))
post_RMSPE = sqrt(mean(gaps[57:99]^2))
ratio=post_RMSPE/pre_RMSPE
print(paste("Lubbock RMSPE ratio:",ratio))


#prep for synthetic control with Dallas as Placebo City
dataprep.out <- dataprep(
  foo = Texas_miles,
  predictors = c("value_5","value_10","value_15","value_20","value_25","value_30","value_35","value_40","value_45","value_50","value_55"),
  predictors.op = "mean",
  time.predictors.prior = c(5,10,15,20,25,30,35,40,45,50,55),
  dependent = "value",
  unit.variable = "X",
  unit.names.variable = "City",
  time.variable = "t",
  treatment.identifier = 5, 
  controls.identifier = c(1,3,4,6,7), 
  time.optimize.ssr = c((0):(56)),
  time.plot = c((0):(99)) 
)

synth.out <- synth(dataprep.out)

# Calculate the treatment effect using mean gap estimates after the treatment
gaps<- dataprep.out$Y1plot-(dataprep.out$Y0plot%*%synth.out$solution.w)

# define pre-treatment periods which are excluded for validation as any period used for matching
exclude_times <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55)
# Define the pre-treatment period
pre_treatment_period <- 0:56
# Filter out the time points to exclude from the pre-treatment period
valid_times <- setdiff(pre_treatment_period, exclude_times)
# Compute gaps for the valid times
valid_gaps <- gaps[valid_times + 1]  
# Calculate RMSPE on the filtered data
pre_RMSPE <- sqrt(mean(valid_gaps^2))
post_RMSPE = sqrt(mean(gaps[57:99]^2))
ratio=post_RMSPE/pre_RMSPE
print(paste("Dallas RMSPE ratio:",ratio))

#prep for synthetic control with Fort Worth as Placebo City
dataprep.out <- dataprep(
  foo = Texas_miles,
  predictors = c("value_5","value_10","value_15","value_20","value_25","value_30","value_35","value_40","value_45","value_50","value_55"),
  predictors.op = "mean",
  time.predictors.prior = c(5,10,15,20,25,30,35,40,45,50,55),
  dependent = "value",
  unit.variable = "X",
  unit.names.variable = "City",
  time.variable = "t",
  treatment.identifier = 6, 
  controls.identifier = c(1,3,4,5,7), 
  time.optimize.ssr = c((0):(56)),
  time.plot = c((0):(99)) 
)

synth.out <- synth(dataprep.out)

# Calculate the treatment effect using mean gap estimates after the treatment
gaps<- dataprep.out$Y1plot-(dataprep.out$Y0plot%*%synth.out$solution.w)

# define pre-treatment periods which are excluded for validation as any period used for matching
exclude_times <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55)
# Define the pre-treatment period
pre_treatment_period <- 0:56
# Filter out the time points to exclude from the pre-treatment period
valid_times <- setdiff(pre_treatment_period, exclude_times)
# Compute gaps for the valid times
valid_gaps <- gaps[valid_times + 1]  
# Calculate RMSPE on the filtered data
pre_RMSPE <- sqrt(mean(valid_gaps^2))
post_RMSPE = sqrt(mean(gaps[57:99]^2))
ratio=post_RMSPE/pre_RMSPE
print(paste("Fort Worth RMSPE ratio:",ratio))

#prep for synthetic control with Plano as Placebo City
dataprep.out <- dataprep(
  foo = Texas_miles,
  predictors = c("value_5","value_10","value_15","value_20","value_25","value_30","value_35","value_40","value_45","value_50","value_55"),
  predictors.op = "mean",
  time.predictors.prior = c(5,10,15,20,25,30,35,40,45,50,55),
  dependent = "value",
  unit.variable = "X",
  unit.names.variable = "City",
  time.variable = "t",
  treatment.identifier = 7, 
  controls.identifier = c(1,3,4,5,6), 
  time.optimize.ssr = c((0):(56)),
  time.plot = c((0):(99)) 
)

synth.out <- synth(dataprep.out)

# Calculate the treatment effect using mean gap estimates after the treatment
gaps<- dataprep.out$Y1plot-(dataprep.out$Y0plot%*%synth.out$solution.w)

# define pre-treatment periods which are excluded for validation as any period used for matching
exclude_times <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55)
# Define the pre-treatment period
pre_treatment_period <- 0:56
# Filter out the time points to exclude from the pre-treatment period
valid_times <- setdiff(pre_treatment_period, exclude_times)
# Compute gaps for the valid times
valid_gaps <- gaps[valid_times + 1]  
# Calculate RMSPE on the filtered data
pre_RMSPE <- sqrt(mean(valid_gaps^2))
post_RMSPE = sqrt(mean(gaps[57:99]^2))
ratio=post_RMSPE/pre_RMSPE
print(paste("Plano RMSPE ratio:",ratio))
```






# Other Robustness Checks

## Winsorized Results

### Parallel Trends for Winsorized Results

```{r}


uber_providers$similar_to_austin=ifelse(uber_providers$mixed==0 &(uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock"),1,0)

new_data_1=subset(uber_providers, similar_to_austin==1 & is.na(Tot_Clms)==FALSE)

cutoff_high=quantile(new_data_1$Tot_Clms, prob=(.999))[[1]]
cutoff_low=quantile(new_data_1$Tot_Clms, prob=(.001))[[1]]


new_data_1$Tot_Clms=Winsorize(new_data_1$Tot_Clms, minval=cutoff_low, maxval=cutoff_high, probs=c(0.001,0.999))



paralleltrends = felm(Tot_Clms ~ I(treatment_group*yearindicator)  + Bene_Avg_Risk_Scre| PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(new_data_1, similar_to_austin==1 & yearindicator<2016 ))


stargazer(paralleltrends,  digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq"),
          add.lines = list(
                           c("Year fixed effects", 'Yes','Yes'), 
                           c('Provider fixed effects', 'Yes','Yes')),
          title = "Parallel Trends", type="text")
```


### Winsorized Results

```{r}



column1 = felm(Tot_Clms ~  I(treatment_group*AfterReentry) + AfterReentry |PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(new_data_1,similar_to_austin==1))

column2 = felm(Tot_Clms ~  I(treatment_group*AfterReentry) |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(new_data_1,similar_to_austin==1))


column3 = felm(Tot_Clms ~  I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(new_data_1,similar_to_austin==1))




stargazer(column1, column2, column3, digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(c("Relative effect", 'No', 'Yes', 'Yes'),
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="text",
          title = "Parallel Trends")

mean(subset(new_data_1,similar_to_austin==1 & treatment_group==0 )$Tot_Clms)

```





## Different Treatment City - Laredo

Here we use Laredo as our treatment city for a robustness check

### Parallel Trends - Laredo

Try to get parallel trends with Laredo, El Paso, Lubbock, and Amarillo

```{r}

uber_providers$similar_to_laredo=ifelse(uber_providers$Prscrbr_City=="Laredo"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock",1,0)

uber_filtered=subset(uber_providers, similar_to_laredo==1)

# Group by 'PRSCRBR_NPI' and count the number of unique 'Prscrbr_City'
provider_city_count <- uber_filtered %>%
  group_by(PRSCRBR_NPI) %>%
  summarise(city_count = n_distinct(Prscrbr_City))

# Get providers that are in more than one city
multi_city_providers <- provider_city_count %>%
  filter(city_count > 1) %>%
  pull(PRSCRBR_NPI)

# Check if these providers have Laredo as one of their cities
providers_with_austin <- uber_filtered %>%
  filter(Prscrbr_City == 'Laredo') %>%
  pull(PRSCRBR_NPI) %>%
  unique()

# Find mixed providers
mixed_providers <- intersect(multi_city_providers, providers_with_austin)

# Create the 'mixed' column in uber_providers
uber_providers <- uber_providers %>% 
  mutate(mixed = ifelse(PRSCRBR_NPI %in% mixed_providers, 1, 0))

uber_providers$similar_to_laredo=ifelse(uber_providers$mixed==0 &(uber_providers$Prscrbr_City=="Laredo"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock"),1,0)


temp=subset(uber_providers, Prscrbr_City=="Laredo")
uber_providers$treatment_laredo=0
uber_providers[uber_providers$PRSCRBR_NPI %in% unique(temp$PRSCRBR_NPI),]$treatment_laredo=1



paralleltrends = felm(Tot_Clms ~ I(treatment_laredo*yearindicator) +  Bene_Avg_Risk_Scre|yearindicator + PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers, yearindicator<2018 & similar_to_laredo==1))


stargazer(paralleltrends, digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq"),
          add.lines = list(
                           c("Year fixed effects", 'Yes','Yes'), 
                           c('Provider fixed effects', 'Yes','Yes')),
          title = "Parallel Trends", type="text")
```


### Total Claims - Laredo

```{r}


column1 = felm(Tot_Clms ~ I(treatment_laredo*AfterReentry) + AfterReentry |PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_laredo==1))

column2 = felm(Tot_Clms ~ I(treatment_laredo*AfterReentry) |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_laredo==1))


column3 = felm(Tot_Clms ~ I(treatment_laredo*AfterReentry) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_laredo==1))


#summary(riskregression)



stargazer(column1,  column2, column3,  digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="text",
          title = "Parallel Trends")

mean(subset(uber_providers,similar_to_austin==1 & treatment_laredo==0)$Tot_Clms)

```

## Placebo test

In this section, we run a time placebo test where we pretend the shock occurs in 2015 for data 2013-2016:

```{r}
uber_providers$similar_to_austin=ifelse((uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock"),1,0)

uber_filtered=subset(uber_providers, similar_to_austin==1)

provider_city_count <- uber_filtered %>%
  group_by(PRSCRBR_NPI) %>%
  summarise(city_count = n_distinct(Prscrbr_City))

# Get providers that are in more than one city
multi_city_providers <- provider_city_count %>%
  filter(city_count > 1) %>%
  pull(PRSCRBR_NPI)

# Check if these providers have Austin as one of their cities
providers_with_austin <- uber_filtered %>%
  filter(Prscrbr_City == 'Austin') %>%
  pull(PRSCRBR_NPI) %>%
  unique()

# Find mixed providers
mixed_providers <- intersect(multi_city_providers, providers_with_austin)

# Create the 'mixed' column in uber_providers
uber_providers <- uber_providers %>% 
  mutate(mixed = ifelse(PRSCRBR_NPI %in% mixed_providers, 1, 0))



uber_providers$similar_to_austin=ifelse(uber_providers$mixed==0 &(uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock"),1,0)

#define placebo after column
uber_providers$placeboAfter = 0
uber_providers$placeboAfter[uber_providers$yearindicator == 2015 | uber_providers$yearindicator == 2016] = 1



column1 = felm(Tot_Clms ~ I(treatment_group*placeboAfter) + placeboAfter|PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & yearindicator<2017))

column2 = felm(Tot_Clms ~ I(treatment_group*placeboAfter) |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & yearindicator<2017))


column3 = felm(Tot_Clms ~ I(treatment_group*placeboAfter) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & yearindicator<2017))



#summary(riskregression)



stargazer(column1,  column2, column3,  digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="text")

```



## Synthetic Did - Provider



```{r cars}
library(synthdid)


uber_sdid= subset(uber_providers, Prscrbr_City=="Austin"|Prscrbr_City=="Dallas"|Prscrbr_City=="Fort Worth"|Prscrbr_City=="El Paso"|Prscrbr_City=="Arlington"|Prscrbr_City=="Plano"|Prscrbr_City=="Lubbock"| Prscrbr_City=="Garland"|Prscrbr_City=="Irving"|Prscrbr_City=="Amarillo"| Prscrbr_City=="Grand Prairie"| Prscrbr_City=="Brownsville"| Prscrbr_City=="McKinney"| Prscrbr_City=="Pasadena"| Prscrbr_City=="Frisco"| Prscrbr_City=="Mesquite")

# Need providers to have all years of data for SDID so here we find all providers which have all years of data

temp=intersect(unique(subset(uber_sdid, yearindicator==2013)$PRSCRBR_NPI),unique(subset(uber_sdid, yearindicator==2014)$PRSCRBR_NPI))
temp=intersect(unique(subset(uber_sdid, yearindicator==2015)$PRSCRBR_NPI), temp)
temp=intersect(unique(subset(uber_sdid, yearindicator==2016)$PRSCRBR_NPI), temp)
temp=intersect(unique(subset(uber_sdid, yearindicator==2017)$PRSCRBR_NPI), temp)
temp=intersect(unique(subset(uber_sdid, yearindicator==2018)$PRSCRBR_NPI), temp)
temp=intersect(unique(subset(uber_sdid, yearindicator==2019)$PRSCRBR_NPI), temp)
temp=intersect(unique(subset(uber_sdid, yearindicator==2020)$PRSCRBR_NPI), temp)


#filter to providers with all years of data
uber_sdid=uber_sdid[uber_sdid$PRSCRBR_NPI %in% temp,]

uber_sdid$treated=ifelse(uber_sdid$treatment_group==1 & uber_sdid$yearindicator>2017,1,0)


provider_city_count <- uber_sdid %>%
  group_by(PRSCRBR_NPI) %>%
  summarise(city_count = n_distinct(Prscrbr_City))

# Get providers that are in more than one city
multi_city_providers <- provider_city_count %>%
  filter(city_count > 1) %>%
  pull(PRSCRBR_NPI)

# Check if these providers have Austin as one of their cities
providers_with_austin <- uber_sdid %>%
  filter(Prscrbr_City == 'Austin') %>%
  pull(PRSCRBR_NPI) %>%
  unique()

# Find mixed providers
mixed_providers <- intersect(multi_city_providers, providers_with_austin)

# Create the 'mixed' column in uber_providers
uber_sdid <- uber_sdid %>% 
  mutate(mixed = ifelse(PRSCRBR_NPI %in% mixed_providers, 1, 0))

uber_sdid=subset(uber_sdid, mixed==0)

#calculate this for relative effect size
mean(subset(uber_sdid, treatment_group==0)$Tot_Clms)

#get columns used for SDID
uber_sdid=uber_sdid[,c("PRSCRBR_NPI","yearindicator","Tot_Clms","treated")]

#setup data for SDID
uber_sdid=uber_sdid[order(uber_sdid[,"yearindicator"], uber_sdid[,"treated"],uber_sdid[,"PRSCRBR_NPI"]), ]
uber_sdid$PRSCRBR_NPI=as.factor(uber_sdid$PRSCRBR_NPI)
setup = panel.matrices(as.data.frame(uber_sdid))


tau.hat_synth = synthdid_estimate(setup$Y, setup$N0, setup$T0)
se = sqrt(vcov(tau.hat_synth, method='jackknife'))



sprintf('point estimate: %1.10f', tau.hat_synth)
sprintf('95%% CI (%1.2f, %1.2f)', tau.hat_synth - 1.96 * se, tau.hat_synth + 1.96 * se)
sprintf('se: %1.10f', se)



```

## Adversarial Imputation

Here we run a robustness check for the truncated nature of the data by adversarially imputing the data.

### Impute the data

```{r}

uber_providers$similar_to_austin=ifelse(uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Lubbock"|uber_providers$Prscrbr_City=="Amarillo",1,0)


# Create a data frame with all combinations of providers and years
all_combinations <- expand.grid(
  PRSCRBR_NPI = unique(subset(uber_providers, similar_to_austin==1)$PRSCRBR_NPI),
  yearindicator = unique(uber_providers$yearindicator)
)

# Left join the original data frame with all combinations to add missing rows with fake_row indicator
merged_df <- all_combinations %>%
  left_join(uber_providers, by = c("PRSCRBR_NPI", "yearindicator")) %>%
  mutate(fake_row = ifelse(is.na(Tot_Clms), 1, 0))

# Create a list of all cities for each provider
provider_cities <- uber_providers %>%
  group_by(PRSCRBR_NPI) %>%
  summarize(cities = list(unique(Prscrbr_City)))

# Update city column for missing total_claims based on all cities for the provider
merged_df <- merged_df %>%
  left_join(provider_cities, by = "PRSCRBR_NPI") %>%
  mutate(city_list = ifelse(is.na(Tot_Clms), map_chr(cities, ~paste(.x, collapse = ", ")), NA)) %>%
  select(-cities)

# Create city column based on what cities it has been in the past, default to Austin if they've been in Austin and more than one city, default to Amarillo if they've not been in Austin and more than one city
merged_df$Prscrbr_City=ifelse(is.na(merged_df$city_list)==FALSE & str_count(merged_df$city_list, ",")==0, merged_df$city_list, merged_df$Prscrbr_City)
merged_df$Prscrbr_City=ifelse(is.na(merged_df$city_list)==FALSE  & str_count(merged_df$city_list, ",")>0, "Amarillo",merged_df$Prscrbr_City)
merged_df$Prscrbr_City=ifelse(is.na(merged_df$city_list)==FALSE & str_count(merged_df$city_list, ",")>0 & grepl("Austin", merged_df$city_list), "Austin",merged_df$Prscrbr_City)

#find providers in Austin
providers_in_austin <- merged_df %>%
  filter(Prscrbr_City == 'Austin') %>%
  pull(PRSCRBR_NPI) %>%
  unique()

# Create treatment_group column
merged_df <- merged_df %>%
  mutate(treatment_group = ifelse(PRSCRBR_NPI %in% providers_in_austin, 1, 0))



merged_df$similar_to_austin=ifelse(merged_df$Prscrbr_City=="Austin"|merged_df$Prscrbr_City=="El Paso"|merged_df$Prscrbr_City=="Lubbock"|merged_df$Prscrbr_City=="Amarillo",1,0)

uber_filtered=subset(merged_df, similar_to_austin==1)

# Group by 'PRSCRBR_NPI' and count the number of unique 'Prscrbr_City'
provider_city_count <- uber_filtered %>%
  group_by(PRSCRBR_NPI) %>%
  summarise(city_count = n_distinct(Prscrbr_City))

# Get providers that are in more than one city
multi_city_providers <- provider_city_count %>%
  filter(city_count > 1) %>%
  pull(PRSCRBR_NPI)

# Check if these providers have Austin as one of their cities
providers_with_austin <- uber_filtered %>%
  filter(Prscrbr_City == 'Austin') %>%
  pull(PRSCRBR_NPI) %>%
  unique()

# Find mixed providers
mixed_providers <- intersect(multi_city_providers, providers_with_austin)

# Create the 'mixed' column in uber_providers
merged_df <- merged_df %>% 
  mutate(mixed = ifelse(PRSCRBR_NPI %in% mixed_providers, 1, 0))

merged_df$similar_to_austin=ifelse(merged_df$mixed==0 & (merged_df$Prscrbr_City=="Austin"|merged_df$Prscrbr_City=="El Paso"|merged_df$Prscrbr_City=="Lubbock"|merged_df$Prscrbr_City=="Amarillo"),1,0)

merged_df$AfterReentry=ifelse(merged_df$yearindicator>2017,1,0)

#Now adversarially impute data as described in paper
merged_df$Tot_Clms=ifelse(merged_df$fake_row==1 & merged_df$treatment_group==0 & merged_df$yearindicator<2018,10,merged_df$Tot_Clms)
merged_df$Tot_Clms=ifelse(merged_df$fake_row==1 & merged_df$treatment_group==0 & merged_df$yearindicator>2017,0,merged_df$Tot_Clms)
merged_df$Tot_Clms=ifelse(merged_df$fake_row==1 & merged_df$treatment_group==1 & merged_df$yearindicator<2018,0,merged_df$Tot_Clms)
merged_df$Tot_Clms=ifelse(merged_df$fake_row==1 & merged_df$treatment_group==1 & merged_df$yearindicator>2017,10,merged_df$Tot_Clms)

merged_df <- merged_df %>%
  group_by(PRSCRBR_NPI) %>%
  mutate(Bene_Avg_Risk_Scre = ifelse(is.na(Bene_Avg_Risk_Scre), mean(Bene_Avg_Risk_Scre, na.rm = TRUE), Bene_Avg_Risk_Scre)) %>%
  ungroup()


```

### Results for Adversarilly Imputed data robustness check

```{r}



column1 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + AfterReentry |PRSCRBR_NPI |0|PRSCRBR_NPI, data=subset(merged_df,similar_to_austin==1))

column2 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) |PRSCRBR_NPI + yearindicator |0|PRSCRBR_NPI, data=subset(merged_df,similar_to_austin==1))


column3 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator |0|PRSCRBR_NPI, data=subset(merged_df,similar_to_austin==1))




stargazer(column1,column2,column3, digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(c("Relative effect", 'No', 'Yes', 'Yes'),
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="latex",
          title = "Parallel Trends")

mean(subset(merged_df,similar_to_austin==1 & treatment_group==0)$Tot_Clms)
```


# Appendix other results

## Both shocks

### Parallel Trends - Austin both shocks

```{r}
uber_providers$similar_to_austin=ifelse(uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock",1,0)

uber_filtered=subset(uber_providers, similar_to_austin==1)

provider_city_count <- uber_filtered %>%
  group_by(PRSCRBR_NPI) %>%
  summarise(city_count = n_distinct(Prscrbr_City))

# Get providers that are in more than one city
multi_city_providers <- provider_city_count %>%
  filter(city_count > 1) %>%
  pull(PRSCRBR_NPI)

# Check if these providers have Corpus Christi as one of their cities
providers_with_austin <- uber_filtered %>%
  filter(Prscrbr_City == 'Austin') %>%
  pull(PRSCRBR_NPI) %>%
  unique()

# Find mixed providers
mixed_providers <- intersect(multi_city_providers, providers_with_austin)

# Create the 'mixed' column in uber_providers
uber_providers <- uber_providers %>% 
  mutate(mixed = ifelse(PRSCRBR_NPI %in% mixed_providers, 1, 0))

uber_providers$similar_to_austin=ifelse(uber_providers$mixed==0 &(uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock"),1,0)


paralleltrends = felm(Tot_Clms ~ I(treatment_group*yearindicator) +  Bene_Avg_Risk_Scre|yearindicator + PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers, yearindicator<2016 & similar_to_austin==1))





stargazer(paralleltrends,  digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'Yes','Yes'), 
                           c('Provider fixed effects', 'Yes','Yes')),
          title = "Parallel Trends", type="text")
```


### Total Claims

```{r}

uber_providers$PreExit=ifelse(uber_providers$yearindicator<2016,1,0)

column1 = felm(Tot_Clms ~ I(treatment_group*PreExit) + PreExit + I(treatment_group*AfterReentry) + AfterReentry |PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 ))

column2 = felm(Tot_Clms ~ I(treatment_group*PreExit) + I(treatment_group*AfterReentry) |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 ))


column3 = felm(Tot_Clms ~  I(treatment_group*PreExit) + I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 ))


#summary(riskregression)



stargazer(column1,  column2, column3,  digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="text",
          title = "Parallel Trends")

mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0)$Tot_Clms)

```




## No Transient Providers
### Parallel Trends - No Transient Providers


```{r}
uber_providers$similar_to_austin=ifelse((uber_providers$Prscrbr_City=="Austin"|uber_providers$Prscrbr_City=="El Paso"|uber_providers$Prscrbr_City=="Amarillo"|uber_providers$Prscrbr_City=="Lubbock"),1,0)


uber_providers <- uber_providers %>%
  group_by(PRSCRBR_NPI) %>%
  mutate(moving_allyears = if_else(n_distinct(Prscrbr_City) > 1, 1, 0)) %>%
  ungroup()


paralleltrends = felm(Tot_Clms ~ I(treatment_group*yearindicator) +  Bene_Avg_Risk_Scre|yearindicator + PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers, yearindicator<2018 & similar_to_austin==1 & moving_allyears==0))


stargazer(paralleltrends,  digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq"),
          add.lines = list(
                           c("Year fixed effects", 'Yes','Yes'), 
                           c('Provider fixed effects', 'Yes','Yes')),
          title = "Parallel Trends", type="text")
```


### Total Claims - No Transient Providers

```{r}


column1 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + AfterReentry|PRSCRBR_NPI|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & moving_allyears==0))

column2 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & moving_allyears==0))


column3 = felm(Tot_Clms ~ I(treatment_group*AfterReentry) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator|0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & moving_allyears==0))


#summary(riskregression)



stargazer(column1,  column2, column3,  digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="text")

mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0 & moving_allyears==0)$Tot_Clms)
```


## Original Exit Results

```{r}

column1 = felm(Tot_Clms ~ I(treatment_group*PreExit) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator |0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & yearindicator<2018))

column2 = felm(Tot_Benes~ I(treatment_group*PreExit) + Bene_Avg_Risk_Scre |PRSCRBR_NPI + yearindicator |0|PRSCRBR_NPI, data=subset(uber_providers,similar_to_austin==1 & yearindicator<2018))




stargazer(column1,column2, digits=2, no.space=TRUE, p.auto=TRUE, omit.stat=c("ser", "adj.rsq","rsq"),
          add.lines = list(
                           c("Year fixed effects", 'No', 'Yes', 'Yes'), 
                           c('Provider fixed effects', 'Yes','Yes','Yes')),type="text",
          title = "Exit Results")

mean(subset(uber_providers,similar_to_austin==1 & treatment_group==0)$Tot_Clms)

```














